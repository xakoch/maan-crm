# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ë–æ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞ –∏ –†–µ—à–µ–Ω–∏–µ

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
Webhook –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É **401 Unauthorized**, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é —Å–µ—Å—Å–∏—é Supabase –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook'–æ–≤ –æ—Ç Telegram.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
–ò–∑–º–µ–Ω–µ–Ω `/app/api/telegram/webhook/route.ts` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **Service Role Client** –≤–º–µ—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.

## –®–∞–≥–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

–í production (Vercel) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
```
TELEGRAM_BOT_TOKEN=8561283244:AAHFF7LcyleYhpuRo7oHgTYpmIMiqOitrO8
NEXT_PUBLIC_APP_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app
SUPABASE_SERVICE_ROLE_KEY=–≤–∞—à_service_role_key
```

### 2. –î–µ–ø–ª–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π

```bash
git add .
git commit -m "fix: telegram webhook authentication"
git push
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:

1. –ó–∞–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É –∫–∞–∫ Super Admin
2. –ù–∞–π–¥–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–ù–∞—Å—Ç—Ä–æ–∏—Ç—å TG –ë–æ—Ç–∞"** (–æ–±—ã—á–Ω–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–∞—à–±–æ—Ä–¥–∞)
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
4. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:

```bash
curl "https://api.telegram.org/bot<–í–ê–®_–¢–û–ö–ï–ù>/getWebhookInfo"
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—Ç–≤–µ—Ç —Å:
- `url`: –≤–∞—à production URL
- `pending_update_count`: 0 (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏)
- –ë–µ–∑ `last_error_message`

### 5. –ü—Ä–∏–≤—è–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫ Telegram

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Link ID** (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–∏–º–≤–æ–ª–æ–≤ ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
3. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
5. –í–≤–µ–¥–∏—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Link ID
6. –ë–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –ø—Ä–∏–≤—è–∑–∫—É

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ª–∏–¥ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
2. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º Telegram –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
3. –í —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –±—É–¥—É—Ç –∫–Ω–æ–ø–∫–∏:
   - ‚úÖ –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
   - ‚ùå –û—Ç–∫–∞–∑–∞—Ç—å
   - üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ Webhook URL: `https://maan-mv2x89njo-tims-projects-e95f5bc5.vercel.app/api/telegram/webhook`
- ‚ö†Ô∏è –û—à–∏–±–∫–∞: 401 Unauthorized (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–¥–µ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–ø–ª–æ–π)
- ‚è≥ –û–∂–∏–¥–∞—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 4

## –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

- `/start` - –ù–∞—á–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –∞–∫–∫–∞—É–Ω—Ç–∞
- `/status` - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≤—è–∑–∫–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1. **Webhook** (`/api/telegram/webhook`) - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Telegram
2. **Setup** (`/api/telegram/setup`) - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç webhook URL
3. **Notify** (`/api/leads/notify`) - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ª–∏–¥–∞—Ö
4. **Bot** (`/lib/telegram/bot.ts`) - –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ Grammy API
5. **Notifications** (`/lib/telegram/notifications.ts`) - –ª–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## Troubleshooting

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook: `curl "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤ `last_error_message`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏–≤—è–∑–∞–Ω (–µ—Å—Ç—å `telegram_id`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `sent_to_telegram` = false –¥–ª—è –ª–∏–¥–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ API `/api/leads/notify`

### 401 Unauthorized
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Service Role Client –≤ webhook
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `SUPABASE_SERVICE_ROLE_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Vercel
